# ============================================================================
# Dockerfile для сборки и запуска приложения To-Do List
# ============================================================================
# Использует многоступенчатую сборку (multi-stage build) для оптимизации
# размера финального образа. Процесс разделен на три этапа:
# 1. Сборка фронтенда (React приложение)
# 2. Сборка бэкенда (TypeScript компиляция)
# 3. Финальный образ (только необходимые файлы для production)
# ============================================================================

# ----------------------------------------------------------------------------
# Этап 1: Сборка фронтенда
# ----------------------------------------------------------------------------
# Используется образ Node.js 18 на базе Alpine Linux (легковесный)
FROM node:18-alpine AS frontend-builder

# Установка рабочей директории для фронтенда
WORKDIR /app/frontend

# Копирование файлов package.json и package-lock.json
# Это делается отдельно для кэширования слоя с зависимостями
# (если package.json не изменился, Docker использует кэш)
COPY frontend/package*.json ./
# Установка зависимостей фронтенда
RUN npm install

# Копирование всех исходных файлов фронтенда
COPY frontend/ ./
# Компиляция React приложения в статические файлы
RUN npm run build

# ----------------------------------------------------------------------------
# Этап 2: Сборка бэкенда
# ----------------------------------------------------------------------------
# Новый базовый образ для сборки бэкенда (независимо от фронтенда)
FROM node:18-alpine AS backend-builder

# Установка рабочей директории для бэкенда
WORKDIR /app

# Копирование файлов package.json и package-lock.json
# Опять же, отдельно для оптимизации кэширования
COPY package*.json ./
# Установка зависимостей бэкенда (включая dev-зависимости для компиляции TypeScript)
RUN npm install

# Копирование конфигурации TypeScript
COPY tsconfig.json ./
# Копирование исходных файлов TypeScript бэкенда
COPY src/ ./src/

# Компиляция TypeScript в JavaScript (результат в папке dist/)
RUN npm run build

# ----------------------------------------------------------------------------
# Этап 3: Финальный образ для production
# ----------------------------------------------------------------------------
# Финальный легковесный образ, содержащий только необходимое для запуска
FROM node:18-alpine

# Установка рабочей директории
WORKDIR /app

# Копирование файлов package.json и package-lock.json
COPY package*.json ./
# Установка только production зависимостей (без dev-зависимостей)
# Это уменьшает размер образа и ускоряет установку
RUN npm install --production

# Копирование скомпилированного бэкенда из этапа backend-builder
# Копируется только папка dist с JavaScript файлами
COPY --from=backend-builder /app/dist ./dist

# Копирование собранного фронтенда из этапа frontend-builder
# Копируются статические файлы React приложения
COPY --from=frontend-builder /app/frontend/build ./frontend/build

# Открытие порта 3000 для доступа к приложению
# Порт будет доступен извне контейнера
EXPOSE 3000

# Команда запуска приложения
# Запускает скомпилированный сервер из папки dist/
CMD ["node", "dist/server.js"]

