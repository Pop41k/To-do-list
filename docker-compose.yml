# ============================================================================
# Docker Compose конфигурация для приложения To-Do List
# ============================================================================
# Определяет два сервиса:
# 1. postgres - база данных PostgreSQL
# 2. app - Node.js приложение (бэкенд + фронтенд)
# ============================================================================

# Версия формата docker-compose файла
version: '3.8'

# Определение сервисов (контейнеров)
services:
  # --------------------------------------------------------------------------
  # Сервис PostgreSQL - база данных
  # --------------------------------------------------------------------------
  postgres:
    # Используется официальный образ PostgreSQL 15 на базе Alpine Linux
    image: postgres:15-alpine
    # Имя контейнера для удобной идентификации
    container_name: chaos-manager-db
    # Переменные окружения для настройки PostgreSQL
    environment:
      POSTGRES_USER: postgres      # Имя пользователя базы данных
      POSTGRES_PASSWORD: postgres  # Пароль пользователя (в production должен быть изменен!)
      POSTGRES_DB: chaos_manager   # Имя создаваемой базы данных
    # Проброс порта 5432 (стандартный порт PostgreSQL) на хост
    ports:
      - "5432:5432"
    # Монтирование тома для персистентного хранения данных БД
    # Данные сохраняются даже после удаления контейнера
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # Проверка здоровья контейнера
    # Используется для определения готовности БД к подключению
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]  # Команда проверки готовности
      interval: 10s  # Интервал проверки (каждые 10 секунд)
      timeout: 5s    # Таймаут выполнения команды проверки
      retries: 5     # Количество повторных попыток

  # --------------------------------------------------------------------------
  # Сервис приложения - Node.js сервер
  # --------------------------------------------------------------------------
  app:
    # Сборка образа из Dockerfile в текущей директории
    build: .
    # Имя контейнера для удобной идентификации
    container_name: chaos-manager-app
    # Проброс порта 3000 (порт приложения) на хост
    ports:
      - "3000:3000"
    # Переменные окружения для настройки приложения
    environment:
      PORT: 3000                    # Порт, на котором запускается приложение
      DB_HOST: postgres             # Хост базы данных (имя сервиса из docker-compose)
      DB_PORT: 5432                 # Порт базы данных
      DB_USERNAME: postgres         # Имя пользователя БД
      DB_PASSWORD: postgres         # Пароль пользователя БД
      DB_NAME: chaos_manager        # Имя базы данных
      NODE_ENV: production          # Режим работы приложения (production)
    # Зависимость от сервиса postgres
    # Приложение запустится только после того, как PostgreSQL будет готов (healthy)
    depends_on:
      postgres:
        condition: service_healthy  # Ожидание успешной проверки здоровья
    # Политика перезапуска контейнера
    # Контейнер будет автоматически перезапускаться при сбое или перезагрузке Docker
    restart: unless-stopped

# --------------------------------------------------------------------------
# Определение именованных томов (volumes)
# --------------------------------------------------------------------------
# Тома используются для персистентного хранения данных между перезапусками контейнеров
volumes:
  # Том для хранения данных PostgreSQL
  postgres_data:

